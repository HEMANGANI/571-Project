<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COVID-19 Global Data Visualization</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .date-range-control {
      width: 100%;
      padding: 0;
    }
    .slider-container {
      width: 90%;
      margin: 0 auto;
      padding: 10px 0;
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      font-size: 12px;
      color: #666;
    }
    select, button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background-color: #676967;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background-color: #768877;
    }
    .chart-container {
      width: 100%;
      height: 500px;
      position: relative;
    }
    .tooltip {
      position: absolute;
      padding: 10px;
      background-color: rgba(0,0,0,0.7);
      color: white;
      border-radius: 5px;
      pointer-events: none;
      font-size: 14px;
      display: none;
      text-align: center;
      z-index: 100;
      max-width: 200px;
    }
    .bar {
      fill: #4ca0af;
      transition: fill 0.3s;
    }
    .bar:hover {
      fill: #465a47;
    }
    .axis-label {
      font-size: 14px;
      text-anchor: middle;
      font-weight: bold;
    }
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #666;
    }
    .error-message {
      color: #d9534f;
      text-align: center;
      font-weight: bold;
      margin: 20px 0;
    }
    .date-display {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
      color: #333;
    }
    
    /* noUiSlider custom styles */
    #dateRangeSlider {
      height: 10px;
      border: none;
      border-radius: 5px;
      background: #d3d3d3;
    }
    #dateRangeSlider .noUi-connect {
      background: #4b4d4b;
    }
    #dateRangeSlider .noUi-handle {
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: #515b51;
      box-shadow: none;
      cursor: pointer;
      border: none;
    }
    #dateRangeSlider .noUi-handle:before,
    #dateRangeSlider .noUi-handle:after {
      display: none;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .chart-container {
        height: 400px;
      }
      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
</head>
<body>
  <div class="container">
    <h1>COVID-19 Global Data Visualization</h1>
    
    <div class="controls">
      <div class="control-group">
        <label for="dataType">Data Type:</label>
        <select id="dataType">
          <option value="confirmed">Confirmed Cases</option>
          <option value="deaths">Deaths</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="normalize">
          <input type="checkbox" id="normalize"> Normalize by Population
        </label>
      </div>
      
      <div class="control-group">
        <label for="topCountries">Top Countries:</label>
        <select id="topCountries">
          <option value="10">Top 10</option>
          <option value="20" selected>Top 20</option>
          <option value="30">Top 30</option>
          <option value="all">All Countries</option>
        </select>
      </div>
      
      <div class="date-range-control">
        <div class="date-display">
          <span id="startDateDisplay"></span> - <span id="endDateDisplay"></span>
        </div>
        <div class="slider-container">
          <div id="dateRangeSlider"></div>
          <div class="slider-labels">
            <span id="minDateLabel"></span>
            <span id="maxDateLabel"></span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="chart-container">
      <div id="loading">Loading data...</div>
      <div id="error-message" class="error-message" style="display: none;"></div>
      <div id="tooltip" class="tooltip"></div>
      <svg id="chart"></svg>
    </div>
  </div>

  <script>
    // Global variables
    let confirmedData = [];
    let deathsData = [];
    let populationData = {};
    let dates = [];
    let startDateIndex = 0;
    let endDateIndex = 0;
    let currentDataType = 'confirmed';
    let isNormalized = false;
    let topN = 20;
    let dataLoaded = false;
    
    // Chart dimensions
    const getChartDimensions = () => {
      const containerWidth = document.querySelector('.chart-container').clientWidth;
      const margin = { top: 50, right: 30, bottom: 120, left: 80 };
      const width = Math.max(containerWidth - margin.left - margin.right, 300);
      const height = 500 - margin.top - margin.bottom;
      return { margin, width, height };
    };
    
    // Initialize chart dimensions
    let { margin, width, height } = getChartDimensions();
    
    // Create the SVG container
    const svg = d3.select("#chart")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);
    
    // Add axes groups
    svg.append("g")
      .attr("class", "x-axis")
      .attr("transform", `translate(0,${height})`);
    
    svg.append("g")
      .attr("class", "y-axis");
    
    // Add axis labels
    svg.append("text")
      .attr("class", "axis-label x-label")
      .attr("x", width / 2)
      .attr("y", height + 80)
      .text("Countries");
    
    svg.append("text")
      .attr("class", "axis-label y-label")
      .attr("transform", "rotate(-90)")
      .attr("x", -height / 2)
      .attr("y", -50)
      .text("Total Cases");
    
    // Add chart title
    svg.append("text")
      .attr("class", "chart-title")
      .attr("x", width / 2)
      .attr("y", -20)
      .attr("text-anchor", "middle")
      .style("font-size", "18px")
      .style("font-weight", "bold")
      .text("COVID-19 Cases by Country");
    
    // Handle window resize to make chart responsive
    window.addEventListener('resize', handleResize);
    
    function handleResize() {
      const { margin, width, height } = getChartDimensions();
      
      // Update SVG dimensions
      d3.select("#chart")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);
      
      // Update x-axis label position
      svg.select(".x-label")
        .attr("x", width / 2)
        .attr("y", height + 60);
      
      // Update y-axis label position
      svg.select(".y-label")
        .attr("x", -height / 2);
      
      // Update chart title position
      svg.select(".chart-title")
        .attr("x", width / 2);
      
      // Re-render the chart with new dimensions
      if (dataLoaded) {
        updateVisualization();
      }
    }
    
    // Initialize the visualization
    async function init() {
      try {
        showLoading(true);
        hideError();
        
        // Load the data files
        [confirmedData, deathsData, populationData] = await Promise.all([
          loadData('time_series_covid19_confirmed_global.csv'),
          loadData('time_series_covid19_deaths_global.csv'),
          loadPopulationData('UID_ISO_FIPS_LookUp_Table.csv')
        ]);
        
        // Check if we have data
        if (!confirmedData.length || !deathsData.length) {
          throw new Error('Failed to load COVID-19 data');
        }
        
        // Extract dates from columns (skip the first 4 columns: Province/State, Country/Region, Lat, Long)
        const firstDataset = confirmedData[0] || {};
        dates = Object.keys(firstDataset).filter(key => !['Province/State', 'Country/Region', 'Lat', 'Long'].includes(key));
        
        if (dates.length > 0) {
          // Setup date sliders
          setupDateSliders();
          
          // Set default values
          startDateIndex = 0;
          endDateIndex = dates.length - 1;
          updateDateDisplay();
          
          currentDataType = 'confirmed';
          isNormalized = false;
          topN = 20;
          
          // Mark data as loaded
          dataLoaded = true;
          
          // Add event listeners
          setupEventListeners();
          
          // Draw initial visualization
          updateVisualization();
        } else {
          throw new Error('No dates found in the data');
        }
      } catch (error) {
        console.error('Error initializing visualization:', error);
        showError(`Error loading data: ${error.message || 'Please check the console for details.'}`);
      } finally {
        showLoading(false);
      }
    }
    
    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('dataType').addEventListener('change', updateVisualization);
      document.getElementById('normalize').addEventListener('change', updateVisualization);
      document.getElementById('topCountries').addEventListener('change', updateVisualization);
    }
    
    // Setup date slider
    function setupDateSliders() {
      const sliderElement = document.getElementById('dateRangeSlider');
      
      // Make sure the element exists
      if (!sliderElement) {
        console.error('Date range slider element not found');
        return;
      }
      
      // Destroy existing slider if it exists
      if (sliderElement.noUiSlider) {
        sliderElement.noUiSlider.destroy();
      }
      
      // Create the noUiSlider
      noUiSlider.create(sliderElement, {
        start: [0, dates.length - 1],
        connect: true,
        step: 1,
        range: {
          'min': 0,
          'max': dates.length - 1
        }
      });
      
      // Set the slider labels
      document.getElementById('minDateLabel').textContent = formatDate(dates[0]);
      document.getElementById('maxDateLabel').textContent = formatDate(dates[dates.length - 1]);
      
      // Add event listener for slider changes
      sliderElement.noUiSlider.on('update', function(values, handle) {
        startDateIndex = Math.round(values[0]);
        endDateIndex = Math.round(values[1]);
        updateDateDisplay();
        updateVisualization();
      });
    }
    
    // Format date for better display
    function formatDate(dateStr) {
      try {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          // Format is MM/DD/YY
          const month = parseInt(parts[0]);
          const day = parseInt(parts[1]);
          const year = 2000 + parseInt(parts[2]); // Assuming 20xx for year
          
          return `${month}/${day}/${year}`;
        }
        return dateStr; // Return as is if format is different
      } catch (e) {
        return dateStr;
      }
    }
    
    // Update date display
    function updateDateDisplay() {
      document.getElementById('startDateDisplay').textContent = formatDate(dates[startDateIndex]);
      document.getElementById('endDateDisplay').textContent = formatDate(dates[endDateIndex]);
    }
    
    // Show/hide loading indicator
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    
    // Show/hide error message
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }
    
    function hideError() {
      document.getElementById('error-message').style.display = 'none';
    }
    
    // Load and parse CSV data with error handling
    async function loadData(filename) {
      try {
        const response = await fetch(`data/${filename}`);
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }
        const csvText = await response.text();
        
        return parseCSV(csvText);
      } catch (error) {
        console.error(`Error loading ${filename}:`, error);
        throw new Error(`Failed to load ${filename}: ${error.message}`);
      }
    }
    
    // Parse CSV text to objects with error handling
    function parseCSV(csvText) {
      try {
        const result = Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true
        });
        
        if (result.errors && result.errors.length > 0) {
          console.warn('CSV parsing had errors:', result.errors);
        }
        
        return result.data || [];
      } catch (error) {
        console.error('Error parsing CSV:', error);
        throw new Error(`Failed to parse CSV data: ${error.message}`);
      }
    }
    
    // Load population data with improved error handling
    async function loadPopulationData(filename) {
      try {
        const response = await fetch(`data/${filename}`);
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }
        const csvText = await response.text();
        const parsed = parseCSV(csvText);
        
        // Create a map of country to population
        const populationMap = {};
        
        parsed.forEach(row => {
          if (row && row.Country_Region && row.Population) {
            // If there's no Province_State or it's empty, it's a country-level entry
            if (!row.Province_State || row.Province_State.trim() === '') {
              populationMap[row.Country_Region] = row.Population;
            }
          }
        });
        
        return populationMap;
      } catch (error) {
        console.error(`Error loading population data:`, error);
        // Return empty object but don't fail completely
        return {};
      }
    }
    
    // Update the visualization based on current selections
    function updateVisualization() {
      if (!dataLoaded) {
        console.warn('Data not yet loaded, cannot update visualization');
        return;
      }
      
      try {
        showLoading(true);
        hideError();
        
        // Get current values from controls
        currentDataType = document.getElementById('dataType').value;
        isNormalized = document.getElementById('normalize').checked;
        const topCountriesSelect = document.getElementById('topCountries');
        topN = topCountriesSelect ? topCountriesSelect.value : 20;
        
        // Update chart dimensions
        ({ margin, width, height } = getChartDimensions());
        
        // Prepare data for visualization
        const data = prepareData();
        
        // Update chart
        drawBarChart(data);
        
        // Update chart labels
        updateChartLabels();
      } catch (error) {
        console.error('Error updating visualization:', error);
        showError(`Error updating chart: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }
    
    // Prepare data for visualization
    function prepareData() {
      // Select the appropriate dataset
      let sourceData;
      if (currentDataType === 'confirmed') {
        sourceData = confirmedData;
      } else {
        sourceData = deathsData;
      }
      
      if (!sourceData || !Array.isArray(sourceData) || sourceData.length === 0) {
        throw new Error(`No data available for ${currentDataType}`);
      }
      
      // Aggregate data by country
      const countryData = aggregateByCountryAndDateRange(sourceData);
      
      // Apply normalization if needed
      if (isNormalized && populationData) {
        Object.keys(countryData).forEach(country => {
          const population = populationData[country];
          if (population && population > 0) {
            countryData[country] = (countryData[country] / population) * 100000; // Per 100,000 people
          } else {
            // If population data is missing, leave the value as is but log a warning
            console.warn(`No population data for ${country}`);
          }
        });
      }
      
      // Convert to array for easier sorting
      let dataArray = Object.entries(countryData)
        .filter(([_, value]) => value > 0 && !isNaN(value)) // Filter out zero and NaN values
        .map(([country, value]) => ({
          country,
          value
        }));
      
      // Sort by value in descending order
      dataArray.sort((a, b) => b.value - a.value);
      
      // Limit to top N countries if specified
      if (topN !== 'all') {
        dataArray = dataArray.slice(0, parseInt(topN));
      }
      
      return dataArray;
    }
    
    // Aggregate data by country and date range (sum values between start and end dates)
    function aggregateByCountryAndDateRange(data) {
      const countryData = {};
      
      // Get the date range
      const endDate = dates[endDateIndex];
      const startDatePrev = startDateIndex > 0 ? dates[startDateIndex - 1] : null;
      
      data.forEach(row => {
        if (!row) return;
        
        const country = row['Country/Region'];
        if (!country) return;
        
        // Initialize country data if not exists
        if (!countryData[country]) {
          countryData[country] = 0;
        }
        
        // For the date range calculation, we need to use the difference between dates
        // If we have data for 1/22/20, 1/23/20, 1/24/20, etc.
        // We want (value at end date) - (value at day before start date)
        // Or if start date is the first date, just use the value at end date
        
        // Get the value at the end date
        const endValue = parseFloat(row[endDate]) || 0;
        
        // Get the value at the day before the start date, or 0 if start date is the first date
        const startValue = startDatePrev 
          ? parseFloat(row[startDatePrev]) || 0 
          : 0;
        
        // Add the difference to the country total
        const increment = Math.max(0, endValue - startValue); // Ensure it's not negative
        countryData[country] += increment;
      });
      
      return countryData;
    }
    
    // Draw the bar chart
    function drawBarChart(data) {
      if (!data || data.length === 0) {
        // Clear the chart if there's no data
        svg.selectAll(".bar").remove();
        return;
      }
      
      // Create scales
      const xScale = d3.scaleBand()
        .domain(data.map(d => d.country))
        .range([0, width])
        .padding(0.2);
      
      const yScale = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.value) * 1.1]) // Add 10% padding at the top
        .range([height, 0]);
      
      // Update axes
      const xAxis = d3.axisBottom(xScale);
      const yAxis = d3.axisLeft(yScale)
        .ticks(10)
        .tickFormat(d => {
          // Format tick labels for readability
          if (d >= 1000000) {
            return `${(d / 1000000).toFixed(1)}M`;
          } else if (d >= 1000) {
            return `${(d / 1000).toFixed(1)}K`;
          }
          return d;
        });
      
      svg.select(".x-axis")
        .attr("transform", `translate(0,${height})`)
        .transition()
        .duration(500)
        .call(xAxis)
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-45)");
      
      svg.select(".y-axis")
        .transition()
        .duration(500)
        .call(yAxis);
      
      // Update bars with proper data binding
      const bars = svg.selectAll(".bar")
        .data(data, d => d.country);
      
      // Remove bars that are no longer needed
      bars.exit()
        .transition()
        .duration(500)
        .attr("y", height)
        .attr("height", 0)
        .remove();
      
      // Add new bars
      bars.enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", d => xScale(d.country))
        .attr("width", xScale.bandwidth())
        .attr("y", height)
        .attr("height", 0)
        .on("mouseover", showTooltip)
        .on("mousemove", moveTooltip)
        .on("mouseout", hideTooltip)
        .transition()
        .duration(500)
        .attr("y", d => yScale(d.value))
        .attr("height", d => height - yScale(d.value));
      
      // Update existing bars
      bars.transition()
        .duration(500)
        .attr("x", d => xScale(d.country))
        .attr("width", xScale.bandwidth())
        .attr("y", d => yScale(d.value))
        .attr("height", d => height - yScale(d.value));
    }
    
    // Show tooltip
    function showTooltip(event, d) {
      const tooltip = d3.select("#tooltip");
      
      let content = `<strong>${d.country}</strong><br>`;
      content += isNormalized 
        ? `${d.value.toLocaleString(undefined, {maximumFractionDigits: 2})} per 100,000 people` 
        : `${d.value.toLocaleString()} cases`;
      
      tooltip
        .html(content)
        .style("display", "block");
      
      moveTooltip(event);
    }
    
    // Move tooltip with mouse
    function moveTooltip(event) {
      const tooltip = d3.select("#tooltip");
      const chartRect = document.querySelector('.chart-container').getBoundingClientRect();
      const tooltipRect = tooltip.node().getBoundingClientRect();
      
      // Calculate position
      let left = event.clientX - chartRect.left;
      let top = event.clientY - chartRect.top;
      
      // Ensure tooltip stays within the chart container
      if (left + tooltipRect.width > chartRect.width) {
        left = left - tooltipRect.width - 10;
      } else {
        left = left + 10;
      }
      
      if (top + tooltipRect.height > chartRect.height) {
        top = top - tooltipRect.height - 10;
      } else {
        top = top + 10;
      }
      
      tooltip
        .style("left", `${left}px`)
        .style("top", `${top}px`);
    }
    
    // Hide tooltip
    function hideTooltip() {
      d3.select("#tooltip").style("display", "none");
    }
    
    // Update chart labels
    function updateChartLabels() {
      let yLabelText;
      let titleText;
      
      if (currentDataType === 'confirmed') {
        titleText = "COVID-19 Confirmed Cases by Country";
        yLabelText = isNormalized ? "Cases per 100,000 people" : "Total Cases";
      } else {
        titleText = "COVID-19 Deaths by Country";
        yLabelText = isNormalized ? "Deaths per 100,000 people" : "Total Deaths";
      }
      
      const dateRangeText = `(${formatDate(dates[startDateIndex])} to ${formatDate(dates[endDateIndex])})`;
      svg.select(".chart-title")
        .text(`${titleText} ${dateRangeText}`);
      
      svg.select(".y-label")
        .text(yLabelText);
    }
    
    // Call init function when the page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>