<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>COVID-19 Country-Specific Pie Chart</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 40px;
    }
    #controls {
      margin-bottom: 20px;
    }
    .tooltip {
      position: absolute;
      opacity: 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 5px;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    svg text {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>COVID-19 Recovery vs Death Pie Chart by Country and Year</h2>

  <div id="controls">
    <label>
      Select Year:
      <select id="yearSelect"></select>
    </label>
    <label style="margin-left: 20px;">
      Country:
      <select id="countrySelect"></select>
    </label>
  </div>

  <svg width="600" height="600"></svg>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const svg = d3.select("svg");
    const tooltip = d3.select("#tooltip");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const radius = Math.min(width, height) / 2 - 40;

    const g = svg.append("g")
      .attr("transform", `translate(${width / 2}, ${height / 2})`);

    const color = d3.scaleOrdinal()
      .domain(["Recovered", "Deaths"])
      .range(["#2ca02c", "#d62728"]);

    const pie = d3.pie().value(d => d.value).sort(null);
    const arc = d3.arc().outerRadius(radius).innerRadius(0);
    const labelArc = d3.arc().outerRadius(radius - 40).innerRadius(radius - 40);

    const yearSelect = document.getElementById("yearSelect");
    const countrySelect = document.getElementById("countrySelect");

    let confirmedByYear = {}, recoveredByYear = {}, deathsByYear = {};

    async function loadData() {
      const [confirmed, recovered, deaths] = await Promise.all([
        d3.csv("data/confirmed.csv"),
        d3.csv("data/recovery.csv"),
        d3.csv("data/death.csv"),
      ]);

      const allDates = confirmed.columns.slice(4);
      const years = [...new Set(allDates.map(d => new Date(d).getFullYear()))].sort();

      years.forEach(year => {
        const yearDates = allDates.filter(date => new Date(date).getFullYear() === +year);

        confirmedByYear[year] = d3.rollup(
          confirmed,
          v => d3.sum(v, d => d3.sum(yearDates, key => +d[key])),
          d => d["Country/Region"]
        );

        recoveredByYear[year] = d3.rollup(
          recovered,
          v => d3.sum(v, d => d3.sum(yearDates, key => +d[key])),
          d => d["Country/Region"]
        );

        deathsByYear[year] = d3.rollup(
          deaths,
          v => d3.sum(v, d => d3.sum(yearDates, key => +d[key])),
          d => d["Country/Region"]
        );
      });

      yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
      yearSelect.addEventListener("change", updateCountryOptions);
      countrySelect.addEventListener("change", () => drawPieChart(yearSelect.value, countrySelect.value));

      updateCountryOptions();
    }

    function updateCountryOptions() {
      const year = yearSelect.value;
      const countries = Array.from(confirmedByYear[year].keys()).sort();
      countrySelect.innerHTML = countries.map(c => `<option value="${c}">${c}</option>`).join("");

      drawPieChart(year, countries[0]);
    }

    function drawPieChart(year, country) {
      const confirmed = confirmedByYear[year].get(country) || 0;
      const recovered = recoveredByYear[year].get(country) || 0;
      const deaths = deathsByYear[year].get(country) || 0;

      const total = recovered + deaths;
      if (total === 0) {
        g.selectAll("*").remove();
        g.append("text").text("No recovery or death data")
         .attr("text-anchor", "middle").attr("dy", ".35em");
        return;
      }

      const data = [
        { label: "Recovered", value: recovered },
        { label: "Deaths", value: deaths }
      ];

      g.selectAll("*").remove();

      const arcs = g.selectAll(".arc")
        .data(pie(data))
        .enter()
        .append("g")
        .attr("class", "arc");

      arcs.append("path")
        .attr("d", arc)
        .attr("fill", d => color(d.data.label))
        .on("mouseover", function(event, d) {
          d3.select(this).attr("opacity", 0.8);
          tooltip.style("opacity", 1)
            .html(`${d.data.label}: ${((d.data.value / total) * 100).toFixed(1)}%<br>(${d3.format(",")(Math.round(d.data.value))})`)
            .style("left", `${event.pageX + 10}px`)
            .style("top", `${event.pageY + 10}px`);
        })
        .on("mousemove", event => {
          tooltip.style("left", `${event.pageX + 10}px`)
                 .style("top", `${event.pageY + 10}px`);
        })
        .on("mouseout", function() {
          d3.select(this).attr("opacity", 1);
          tooltip.style("opacity", 0);
        });

      arcs.append("text")
        .attr("transform", d => `translate(${labelArc.centroid(d)})`)
        .attr("dy", "0.35em")
        .attr("text-anchor", "middle")
        .text(d => `${d.data.label} (${((d.data.value / total) * 100).toFixed(1)}%)`);
    }

    loadData();
  </script>
</body>
</html>
