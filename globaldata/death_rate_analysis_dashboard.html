<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>COVID Death Rate Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }
    .controls {
      margin: 20px auto;
    }
    label {
      margin: 0 10px;
    }
    .tooltip {
      position: absolute;
      opacity: 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 5px;
      pointer-events: none;
      transition: opacity 0.3s;
    }
  </style>
</head>
<body>

  <h2>COVID-19 Death Rate Dashboard</h2>
  <p style="font-weight: bold;">
    Death Rate = (Deaths in Year / Confirmed in Year) Ã— 100
  </p>

  <div class="controls">
    <label>
      Top N countries:
      <input type="number" id="topN" value="10" min="1" max="50" />
    </label>
    <label>
      Year:
      <select id="yearSelect"></select>
    </label>
    <label>
      Sort order:
      <select id="sortOrder">
        <option value="desc">Descending</option>
        <option value="asc">Ascending</option>
      </select>
    </label>
  </div>

  <div style="position: relative;">
    <svg id="chart" width="900" height="600"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const svg = d3.select("#chart");
    const tooltip = document.getElementById("tooltip");
    const topNInput = document.getElementById("topN");
    const yearSelect = document.getElementById("yearSelect");
    const sortOrderSelect = document.getElementById("sortOrder");

    const margin = { top: 50, right: 50, bottom: 100, left: 80 };
    const width = 900, height = 600;
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    let dataByYear = {};

    function getDateColumns(data) {
      return Object.keys(data[0]).filter(col => /^\d{1,2}\/\d{1,2}\/\d{2}$/.test(col));
    }

    function getLastDateOfYear(columns, year) {
      const dates = columns
        .map(d => new Date(d))
        .filter(d => d.getFullYear() === +year)
        .sort((a, b) => b - a);
      return dates.length ? d3.timeFormat("%-m/%-d/%y")(dates[0]) : null;
    }

    function computeYearlyTotals(rawData, dateCols, year) {
      const lastDateCurr = getLastDateOfYear(dateCols, year);
      const lastDatePrev = getLastDateOfYear(dateCols, year - 1);

      return d3.rollup(
        rawData,
        rows => {
          const endOfYear = d3.sum(rows, r => +r[lastDateCurr] || 0);
          const startOfYear = lastDatePrev ? d3.sum(rows, r => +r[lastDatePrev] || 0) : 0;
          return endOfYear - startOfYear;
        },
        d => d["Country/Region"]
      );
    }

    async function loadData() {
      try {
        const [confirmed, deaths] = await Promise.all([
          d3.csv("data/confirmed.csv"),
          d3.csv("data/death.csv")
        ]);

        const dateCols = getDateColumns(confirmed);
        const years = [...new Set(dateCols.map(d => new Date(d).getFullYear()))].sort();

        years.forEach(year => {
          const confirmedYearly = computeYearlyTotals(confirmed, dateCols, year);
          const deathsYearly = computeYearlyTotals(deaths, dateCols, year);

          dataByYear[year] = Array.from(confirmedYearly.entries()).map(([country, cases]) => ({
            country,
            cases,
            deaths: deathsYearly.get(country) || 0
          }));
        });

        yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
        updateDeathChart();
      } catch (error) {
        console.error("Error loading data:", error);
      }
    }

    function drawDeathChart(topN, year, sortOrder) {
      svg.selectAll("*").remove();

      const countries = dataByYear[year]
        .filter(d => d.cases > 0)
        .map(d => ({
          country: d.country,
          cases: d.cases,
          deaths: d.deaths,
          deathRate: (d.deaths / d.cases) * 100
        }))
        .sort((a, b) => sortOrder === "asc"
          ? a.deathRate - b.deathRate
          : b.deathRate - a.deathRate)
        .slice(0, topN);

      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scaleBand()
        .domain(countries.map(d => d.country))
        .range([0, innerWidth])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([0, d3.max(countries, d => d.deathRate)])
        .nice()
        .range([innerHeight, 0]);

      g.append("g")
        .attr("transform", `translate(0,${innerHeight})`)
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");

      g.append("g")
        .call(d3.axisLeft(y).ticks(10).tickFormat(d => d + "%"));

      g.selectAll("rect")
        .data(countries)
        .enter()
        .append("rect")
        .attr("x", d => x(d.country))
        .attr("y", d => y(d.deathRate))
        .attr("width", x.bandwidth())
        .attr("height", d => innerHeight - y(d.deathRate))
        .attr("fill", "#d62728")
        .on("mouseover", function(event, d) {
          d3.select(this).attr("opacity", 0.8);
          tooltip.style.opacity = 1;
          tooltip.innerHTML = `
            <strong>${d.country}</strong><br>
            Death Rate: ${d.deathRate.toFixed(2)}%<br>
            Cases: ${d3.format(",")(d.cases)}<br>
            Deaths: ${d3.format(",")(d.deaths)}
          `;
        })
        .on("mousemove", function(event) {
          tooltip.style.left = `${event.pageX + 10}px`;
          tooltip.style.top = `${event.pageY + 10}px`;
        })
        .on("mouseout", function() {
          d3.select(this).attr("opacity", 1);
          tooltip.style.opacity = 0;
        });

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top / 2)
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        .style("font-weight", "bold")
        .text(`Top ${topN} Countries by Death Rate in ${year}`);
    }

    function updateDeathChart() {
      drawDeathChart(
        +topNInput.value,
        yearSelect.value,
        sortOrderSelect.value
      );
    }

    topNInput.addEventListener("input", updateDeathChart);
    yearSelect.addEventListener("change", updateDeathChart);
    sortOrderSelect.addEventListener("change", updateDeathChart);

    loadData();
  </script>
</body>
</html>
