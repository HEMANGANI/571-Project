<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>COVID Visualization</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    h2 {
      margin-top: 20px;
    }

    .controls {
      margin: 20px auto;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .controls label {
      font-weight: bold;
    }

    input[type="number"],
    select {
      margin-left: 10px;
      padding: 5px;
      font-size: 14px;
    }

    #chart-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      position: relative;
    }

    .tooltip {
      position: absolute;
      opacity: 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 5px;
      pointer-events: none;
      transition: opacity 0.3s;
    }
  </style>
</head>
<body>

  <h2>Top Countries by COVID-19 Cases, Deaths, and Recoveries</h2>

  <div class="controls">
    <label>
      Number of countries to show:
      <input type="number" id="topN" value="10" min="1" max="20" />
    </label>
    <label>
      Select year:
      <select id="yearSelect"></select>
    </label>
  </div>

  <div id="chart-container">
    <svg id="chart" width="900" height="600"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const svg = d3.select("#chart");
    const tooltip = document.getElementById("tooltip");
    const topNInput = document.getElementById("topN");
    const yearSelect = document.getElementById("yearSelect");

    let dataByYear = {};
    const margin = { top: 50, right: 50, bottom: 100, left: 80 };
    const width = 900, height = 600;
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function processYearlyDelta(rawData, year) {
      const allDates = Object.keys(rawData[0]).slice(4); // Skip lat/long
      const datesForYear = allDates.filter(d => new Date(d).getFullYear() === +year);

      if (datesForYear.length === 0) return new Map();

      const earliest = datesForYear[0];
      const latest = datesForYear[datesForYear.length - 1];

      return d3.rollup(
        rawData,
        v => d3.sum(v, row => +row[latest] - +row[earliest]),
        d => d['Country/Region']
      );
    }

    async function loadData() {
      try {
        const [confirmed, deaths, recovered] = await Promise.all([
          d3.csv("data/confirmed.csv"),
          d3.csv("data/death.csv"),
          d3.csv("data/recovery.csv")
        ]);

        const allYears = [...new Set(
          Object.keys(confirmed[0])
            .slice(4)
            .map(d => new Date(d).getFullYear())
        )].sort();

        allYears.forEach(year => {
          const confirmedTotals = processYearlyDelta(confirmed, year);
          const deathsTotals = processYearlyDelta(deaths, year);
          const recoveredTotals = processYearlyDelta(recovered, year);

          dataByYear[year] = Array.from(confirmedTotals.entries()).map(([country, cases]) => ({
            country,
            cases,
            deaths: deathsTotals.get(country) || 0,
            recovered: recoveredTotals.get(country) || 0
          })).sort((a, b) => b.cases - a.cases);
        });

        yearSelect.innerHTML = allYears.map(y => `<option value="${y}">${y}</option>`).join("");

        drawChart(+topNInput.value, yearSelect.value);
      } catch (error) {
        console.error("Error loading data:", error);
      }
    }

    function drawChart(topN, year) {
      svg.selectAll("*").remove();

      const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const topCountries = dataByYear[year].slice(0, topN);
      const metrics = ['cases', 'deaths', 'recovered'];

      const x0 = d3.scaleBand()
        .domain(topCountries.map(d => d.country))
        .range([0, innerWidth])
        .paddingInner(0.2)
        .paddingOuter(0.2);

      const x1 = d3.scaleBand()
        .domain(metrics)
        .range([0, x0.bandwidth()])
        .padding(0.1);

      const y = d3.scaleLinear()
        .domain([0, d3.max(topCountries, d => d.cases)])
        .nice()
        .range([innerHeight, 0]);

      const color = d3.scaleOrdinal()
        .domain(metrics)
        .range(['#1f77b4', '#d62728', '#2ca02c']);

      g.append("g")
        .attr("transform", `translate(0,${innerHeight})`)
        .call(d3.axisBottom(x0))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-45)");

      g.append("g")
        .call(d3.axisLeft(y).ticks(10).tickFormat(d => {
          if (d >= 1_000_000_000) return (d / 1_000_000_000) + " billion";
          if (d >= 1_000_000) return (d / 1_000_000) + " million";
          if (d >= 1_000) return (d / 1_000) + " thousand";
          return d;
        }))
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -innerHeight / 2)
        .attr("y", -60)
        .attr("text-anchor", "middle")
        .attr("fill", "black")
        .attr("font-weight", "bold")
        .text("Count");

      const countryGroups = g.selectAll(".country-group")
        .data(topCountries)
        .enter()
        .append("g")
        .attr("class", "country-group")
        .attr("transform", d => `translate(${x0(d.country)},0)`);

      countryGroups.selectAll("rect")
        .data(d => metrics.map(key => ({ key, value: d[key], country: d.country })))
        .enter()
        .append("rect")
        .attr("x", d => x1(d.key))
        .attr("y", d => y(d.value))
        .attr("width", x1.bandwidth())
        .attr("height", d => innerHeight - y(d.value))
        .attr("fill", d => color(d.key))
        .on("mouseover", function(event, d) {
          d3.select(this).attr("opacity", 0.8);
          tooltip.style.opacity = 1;
          tooltip.innerHTML = `<div><strong>${d.country}</strong></div><div>${capitalize(d.key)} (new in ${year}): ${d3.format(",")(d.value)}</div>`;
        })
        .on("mousemove", function(event) {
          tooltip.style.left = `${event.pageX + 10}px`;
          tooltip.style.top = `${event.pageY + 10}px`;
        })
        .on("mouseout", function() {
          d3.select(this).attr("opacity", 1);
          tooltip.style.opacity = 0;
        });

      const legend = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top + innerHeight + 40})`);

      metrics.forEach((metric, i) => {
        const item = legend.append("g")
          .attr("transform", `translate(${i * 100}, 0)`);

        item.append("rect")
          .attr("width", 18)
          .attr("height", 18)
          .attr("fill", color(metric));

        item.append("text")
          .attr("x", 24)
          .attr("y", 9)
          .attr("dy", ".35em")
          .text(capitalize(metric));
      });

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top / 2)
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        .style("font-weight", "bold")
        .text(`Top ${topN} Countries by New COVID-19 Cases, Deaths & Recoveries in ${year}`);

      
    }

    topNInput.addEventListener("input", () => {
      drawChart(+topNInput.value, yearSelect.value);
    });

    yearSelect.addEventListener("change", () => {
      drawChart(+topNInput.value, yearSelect.value);
    });

    loadData();
  </script>
</body>
</html>
